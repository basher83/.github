name: Sync Labels from Central Definition

on:
  workflow_call:
    inputs:
      label_definitions_url:
        required: false
        type: string
        default: "https://raw.githubusercontent.com/basher83/docs/main/mission-control/github-configs/label-definitions.yml"

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v5

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.45.4/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download central label definitions
        run: |
          LABEL_URL="${{ inputs.label_definitions_url }}"
          echo "Downloading label definitions from $LABEL_URL..."
          if ! curl -sSL -f -o label-definitions.yml "$LABEL_URL"; then
            echo "‚ùå Failed to download label definitions from central repository"
            exit 1
          fi
          echo "‚úÖ Successfully downloaded label definitions"

      - name: Validate source file
        run: |
          echo "Validating source file structure..."
          if [[ ! -f label-definitions.yml ]]; then
            echo "‚ùå Source file not found"
            exit 1
          fi

          # Check if file is valid YAML
          if ! yq eval '.' label-definitions.yml > /dev/null 2>&1; then
            echo "‚ùå Invalid YAML format in source file"
            exit 1
          fi

          # Check if file has expected structure
          if ! yq eval 'keys | length > 0' label-definitions.yml > /dev/null 2>&1; then
            echo "‚ùå No label categories found in source file"
            exit 1
          fi

          echo "‚úÖ Source file validation passed"
          echo "üìä Label categories found:"
          yq eval 'keys | .[]' label-definitions.yml | sed 's/^/  - /'

      - name: Transform labels
        run: |
          echo "Transforming labels for label-syncer..."

          # Transform the nested structure to flat array
          yq eval '[.[] | .[]]' label-definitions.yml > transformed-labels.yml

          # Validate transformed file
          if [[ ! -f transformed-labels.yml ]]; then
            echo "‚ùå Failed to create transformed labels file"
            exit 1
          fi

          # Check if transformation produced valid results
          label_count=$(yq eval 'length' transformed-labels.yml)
          if [[ $label_count -eq 0 ]]; then
            echo "‚ùå No labels found after transformation"
            exit 1
          fi

          echo "‚úÖ Successfully transformed labels"
          echo "üìà Total labels to sync: $label_count"

          # Show sample of transformed labels (first 5)
          echo "üìã Sample of labels to be synced:"
          yq eval '.[0:5] | .[] | "  - " + .name + " (" + .color + ")"' transformed-labels.yml

      - name: Dry run - Show what will be synced
        run: |
          echo "üîç Dry run summary:"
          echo "Repository: ${{ github.repository }}"
          echo "Labels will be synced with prune=true (unused labels will be removed)"
          echo ""
          echo "Label categories breakdown:"
          yq eval 'group_by(.description | split(" ") | .[0]) | .[] | "  " + (.[0].description | split(" ") | .[0]) + ": " + (length | tostring) + " labels"' transformed-labels.yml | sort | uniq -c | sed 's/^/  /'

      - name: Sync labels to this repository
        uses: micnncim/action-label-syncer@v1.3.0
        with:
          manifest: transformed-labels.yml
          prune: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post-sync summary
        if: always()
        run: |
          echo "üéâ Label sync completed!"
          echo "Repository: ${{ github.repository }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "‚ÑπÔ∏è Note: Labels not defined in the central configuration have been removed due to prune=true"
