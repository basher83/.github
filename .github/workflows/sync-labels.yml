name: Sync Labels from Central Definition

on:
  workflow_call:
    inputs:
      label_definitions_url:
        required: false
        type: string
        default: "https://raw.githubusercontent.com/basher83/.github/main/.github/labels/label-definitions.yml"

jobs:
  sync-labels:
    runs-on: ubuntu-latest
    permissions:
      # contents: read
      issues: write

    steps:
      - name: Random jitter to avoid thundering herd (scheduled runs only)
        if: github.event_name == 'schedule'
        run: |
          # Sleep between 0 and 600 seconds (0 to 10 minutes)
          JITTER=$(( RANDOM % 600 ))
          echo "Applying random jitter: ${JITTER}s"
          sleep "${JITTER}"

      - name: Checkout this repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.45.4/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Download central label definitions
        run: |
          LABEL_URL="${{ inputs.label_definitions_url }}"
          echo "Downloading label definitions from $LABEL_URL..."
          if ! curl -sSL -f -o label-definitions.yml "$LABEL_URL"; then
            echo "‚ùå Failed to download label definitions from central repository"
            exit 1
          fi
          echo "‚úÖ Successfully downloaded label definitions"

      - name: Validate source file
        run: |
          echo "Validating source file structure..."
          if [[ ! -f label-definitions.yml ]]; then
            echo "‚ùå Source file not found"
            exit 1
          fi

          # Check if file is valid YAML
          if ! yq eval '.' label-definitions.yml > /dev/null 2>&1; then
            echo "‚ùå Invalid YAML format in source file"
            exit 1
          fi

          # Check if file has expected structure (at least one top-level key)
          if ! yq eval 'keys | length > 0' label-definitions.yml > /dev/null 2>&1; then
            echo "‚ùå No label categories found in source file"
            exit 1
          fi

          echo "‚úÖ Source file validation passed"
          echo "üìä Label categories found:"
          yq eval 'keys | .[]' label-definitions.yml | sed 's/^/  - /'

      - name: Transform labels
        run: |
          echo "Transforming labels for label-syncer..."

          # Transform nested structure to flat array of labels
          yq eval '[.[] | .[]]' label-definitions.yml > transformed-labels.yml

          if [[ ! -f transformed-labels.yml ]]; then
            echo "‚ùå Failed to create transformed labels file"
            exit 1
          fi

          label_count=$(yq eval 'length' transformed-labels.yml)
          if [[ $label_count -eq 0 ]]; then
            echo "‚ùå No labels found after transformation"
            exit 1
          fi

          echo "‚úÖ Successfully transformed labels"
          echo "üìà Total labels to sync: $label_count"

          echo "üìã Sample of labels to be synced (first 5):"
          yq eval '.[0:5] | .[] | "  - " + .name + " (" + .color + ")"' transformed-labels.yml

      - name: Sync labels to this repository
        uses: micnncim/action-label-syncer@3abd5ab72fda571e69fffd97bd4e0033dd5f495c # v1.3.0
        with:
          manifest: transformed-labels.yml
          prune: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Post-sync summary
        if: always()
        run: |
          echo "üéâ Label sync completed!"
          echo "Repository: ${GITHUB_REPOSITORY}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Triggered by: ${{ github.actor }}"
          echo ""
          echo "‚ÑπÔ∏è Note: Labels not defined in the central configuration have been removed due to prune=true"